<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>PDF 메타데이터 오버레이 뷰어</title>
    <style>
      .page-container {
        position: relative;
        margin-bottom: 40px;
        display: inline-block;
        border: 1px solid #ccc;
      }
      .page-image {
        display: block;
        max-width: none;
      }
      .highlight {
        position: absolute;
        border: 2px dashed red;
        background-color: transparent;
        transition: background-color 0.2s;
      }
      .highlight:hover {
        background-color: rgba(255, 255, 0, 0.3);
      }
    </style>
  </head>
  <body>
    <h2>메타데이터</h2>
    <div id="pages"></div>

    <script>
      const SCALE = 1;

      fetch("output.xml")
        .then((res) => res.text())
        .then((xmlText) => {
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(xmlText, "application/xml");
          const pages = xmlDoc.querySelectorAll("page");
          const container = document.getElementById("pages");

          pages.forEach((page) => {
            const pageNum = page.getAttribute("number");
            const pageHeight = parseFloat(page.getAttribute("height")) * SCALE;

            const pageDiv = document.createElement("div");
            pageDiv.className = "page-container";

            const img = document.createElement("img");
            img.src = `page${pageNum}.png`;
            img.className = "page-image";

            const ptToPx = (pt) => pt * (96 / 72);

            img.onload = () => {
              const pageWidthPt = parseFloat(page.getAttribute("width"));
              const pageHeightPt = parseFloat(page.getAttribute("height"));

              const pageWidthPx = ptToPx(pageWidthPt);
              const pageHeightPx = ptToPx(pageHeightPt);

              const imageWidth = img.naturalWidth;
              const imageHeight = img.naturalHeight;

              const scaleX = imageWidth / pageWidthPx;
              const scaleY = imageHeight / pageHeightPx;

              pageDiv.style.width = imageWidth + "px";
              pageDiv.style.height = imageHeight + "px";

              const texts = page.querySelectorAll("text");
              texts.forEach((text) => {
                const value = text.getAttribute("value");

                const xPt = parseFloat(text.getAttribute("x"));
                const yPt = parseFloat(text.getAttribute("y"));
                const widthPt = parseFloat(text.getAttribute("width"));
                const heightPt = parseFloat(text.getAttribute("height"));

                const x = ptToPx(xPt) * scaleX;
                const y = ptToPx(yPt) * scaleY;
                const width = ptToPx(widthPt) * scaleX;
                const height = ptToPx(heightPt) * scaleY;

                const top = imageHeight - y - height;

                const box = document.createElement("div");
                box.className = "highlight";
                box.style.left = `${x}px`;
                box.style.top = `${top}px`;
                box.style.width = `${width}px`;
                box.style.height = `${height}px`;
                box.title = value;

                pageDiv.appendChild(box);
              });
            };

            pageDiv.appendChild(img);
            container.appendChild(pageDiv);
          });
        });
    </script>
  </body>
</html>
